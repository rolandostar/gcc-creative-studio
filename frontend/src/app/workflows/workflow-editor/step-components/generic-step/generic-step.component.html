<!--
 Copyright 2026 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->


<div class="step-card" [formGroup]="stepForm" [ngClass]="localConfig.type" [class.invalid-step]="stepForm.invalid && showValidationErrors">
  <div class="step-header" (click)="isCollapsed = !isCollapsed" cdkDragHandle>
    <div class="step-title">
      <mat-icon>{{ localConfig.icon }}</mat-icon>
      <span>{{ localConfig.title }}</span>
      <mat-icon *ngIf="stepForm.invalid && showValidationErrors" class="!text-red-500 ml-2" matTooltip="Step has errors">error</mat-icon>
      <span class="step-id-subtle">#{{ stepIndex + 1 }}</span>
      <!-- Status Chip -->
      <mat-chip *ngIf="stepForm.get('status')?.value !== 'idle'" 
                [ngClass]="getStatusClass(stepForm.get('status')?.value)"
                class="ml-2">
        <mat-icon *ngIf="getStatusIcon(stepForm.get('status')?.value)" class="!text-sm !w-4 !h-4 mr-1">
          {{ getStatusIcon(stepForm.get('status')?.value) }}
        </mat-icon>
        {{ stepForm.get('status')?.value | uppercase }}
      </mat-chip>
    </div>
    <div class="step-actions">
      <button *ngIf="mode !== 'run'" mat-icon-button color="warn"
              (click)="$event.stopPropagation(); delete.emit()" matTooltip="Delete step">
        <mat-icon>delete</mat-icon>
      </button>
      <button mat-icon-button class="collapse-icon">
        <mat-icon>{{ isCollapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
      </button>
    </div>
  </div>

  <div class="step-body" *ngIf="!isCollapsed">
    <div class="section inputs" formGroupName="inputs">
      <h3>Inputs</h3>
      <ng-container *ngFor="let input of localConfig.inputs">
        <div class="input-group" *ngIf="!input.hidden">
        <label>{{ input.label }}</label>

        <div [class.controls-row]="inputModes[input.name] !== 'mixed'" [class.mb-4]="inputModes[input.name] === 'mixed'">
          <!-- Inputs mixed (List of fixed/linked) -->
          <div class="input-container-mixed" *ngIf="inputModes[input.name] === 'mixed'">
              
               <!-- Counter -->
              <div class="text-xs text-neutral-500 mb-2 font-medium">
                  {{ referenceImages[input.name].length || 0 }}/{{ currentMaxReferenceImages }} items selected
              </div>

              <!-- List of current items -->
              <div class="flex flex-wrap gap-2 mb-2" *ngIf="referenceImages[input.name]?.length">
                <div *ngFor="let item of referenceImages[input.name]; let i = index" 
                     class="relative h-20 w-20 flex-shrink-0 group rounded-lg overflow-hidden border border-neutral-700 bg-neutral-800">
                  
                  <!-- Case 1: Fixed Image/Video -->
                  <ng-container *ngIf="!isStepOutputReference(item)">
                      <img *ngIf="$any(item).previewUrl" [src]="$any(item).previewUrl" class="h-full w-full object-cover" />
                      <!-- Fallback/Icon if no preview -->
                      <div *ngIf="!$any(item).previewUrl" class="h-full w-full flex items-center justify-center">
                          <mat-icon class="text-neutral-500">image</mat-icon>
                      </div>
                  </ng-container>

                  <!-- Case 2: Linked Output -->
                  <ng-container *ngIf="isStepOutputReference(item)">
                      <div class="h-full w-full flex flex-col items-center justify-center p-1 text-center bg-blue-900/20">
                          <mat-icon class="text-blue-400 !w-5 !h-5 !text-lg">link</mat-icon>
                          <span class="text-[9px] text-blue-200 leading-tight mt-1 line-clamp-2">
                              {{ getLinkedOutputLabel(item) }}
                          </span>
                      </div>
                  </ng-container>

                  <!-- Delete Button -->
                  <button
                    (click)="clearReferenceImage(input.name, i)"
                    class="absolute top-0 right-0 p-0.5 bg-black/50 text-white hover:bg-red-500 rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity"
                  >
                    <mat-icon class="!h-4 !w-4 !text-sm">close</mat-icon>
                  </button>
                </div>
              </div>

               <!-- Add Buttons (Always on new row) -->
               <div class="flex gap-2" *ngIf="(referenceImages[input.name]?.length || 0) < currentMaxReferenceImages">
                   <!-- Add Fixed -->
                  <div 
                        class="h-10 w-10 flex flex-col items-center justify-center cursor-pointer rounded-lg border-2 border-dashed border-neutral-700 hover:border-neutral-500 hover:bg-neutral-800 transition-colors gap-1"
                        (click)="openImageSelectorForReference(input.name, $any(input.type))"
                        matTooltip="Add {{ input.type === 'video' ? 'Video' : 'Image' }}">
                        <mat-icon class="text-neutral-400 !w-5 !h-5 !text-xl">add_photo_alternate</mat-icon>
                    </div>
                  
                  <!-- Add Linked -->
                    <div 
                        class="h-10 w-10 flex flex-col items-center justify-center cursor-pointer rounded-lg border-2 border-dashed border-neutral-700 hover:border-blue-500/50 hover:bg-blue-900/10 transition-colors gap-1"
                        [matMenuTriggerFor]="outputMenu"
                        matTooltip="Add Output Reference">
                        <mat-icon class="text-blue-400 !w-5 !h-5 !text-xl">link</mat-icon>
                    </div>
                  
                  <mat-menu #outputMenu="matMenu">
                      <button mat-menu-item *ngFor="let out of compatibleOutputs[input.name]" (click)="addLinkedOutput(input.name, out)">
                          {{ out.label }}
                      </button>
                      <div *ngIf="!compatibleOutputs[input.name]?.length" class="px-4 py-2 text-sm text-neutral-500">
                          No compatible outputs
                      </div>
                  </mat-menu>
               </div>
               <mat-error *ngIf="showValidationErrors && stepForm.get('inputs')?.get(input.name)?.hasError('required') && !referenceImages[input.name]?.length">
                   At least one input is required
               </mat-error>
          </div>

          <mat-form-field *ngIf="inputModes[input.name] !== 'mixed'" appearance="outline" class="mode-select">
            <mat-select [value]="inputModes[input.name]" (selectionChange)="toggleInputMode(input.name, $event.value)">
              <mat-option value="fixed">Fixed</mat-option>
              <mat-option value="linked">Link</mat-option>
            </mat-select>
          </mat-form-field>
          <!-- Textarea Input -->
          <mat-form-field *ngIf="inputModes[input.name] === 'fixed' && input.type === 'textarea'" appearance="outline" class="value-input">
            <textarea matInput [formControlName]="input.name" [placeholder]="input.label" rows="2"></textarea>
            <mat-error *ngIf="showValidationErrors && stepForm.get('inputs')?.get(input.name)?.hasError('required')">
              {{ input.label }} is required
            </mat-error>
          </mat-form-field>
          <!-- Text Input -->
          <mat-form-field *ngIf="inputModes[input.name] === 'fixed' && input.type === 'text'" appearance="outline" class="value-input">
            <input matInput [formControlName]="input.name" [placeholder]="input.label">
            <mat-error *ngIf="showValidationErrors && stepForm.get('inputs')?.get(input.name)?.hasError('required')">
              {{ input.label }} is required
            </mat-error>
          </mat-form-field>
          <!-- Inputs image -->
          <div class="flex items-center gap-3" *ngIf="inputModes[input.name] === 'fixed' && (input.type === 'image' || input.type === 'video')">
              <div
                class="relative h-16 w-16 cursor-pointer rounded-xl border-2 border-dashed transition-colors flex items-center justify-center"
                [ngClass]="{
                  'border-red-500 bg-red-500/10': stepForm.get('inputs')?.get(input.name)?.invalid && showValidationErrors,
                  'border-neutral-700 bg-neutral-800 hover:border-neutral-500 hover:bg-neutral-700': !(stepForm.get('inputs')?.get(input.name)?.invalid && showValidationErrors)
                }"
                [class.opacity-50]="(referenceImages[input.name].length || 0) >= (input.type === 'image' ? currentMaxReferenceImages : 1)"
                (click)="(referenceImages[input.name].length || 0) < (input.type === 'image' ? currentMaxReferenceImages : 1) && openImageSelectorForReference(input.name, $any(input.type))"
                (dragover)="$event.preventDefault()"
                (drop)="$event.preventDefault(); input.type === 'image' && onReferenceImageDrop($event, input.name)"
                >
                <mat-icon class="text-neutral-500">
                  {{ input.type === 'image' ? 'add_photo_alternate' : 'video_library' }}
                </mat-icon>
                <span *ngIf="input.type === 'image'" class="absolute bottom-1 text-[10px] text-neutral-500">{{ (referenceImages[input.name].length || 0) }}/{{ currentMaxReferenceImages }}</span>
              </div>
              <!-- Show small previews of reference images -->
              <div class="flex gap-1 overflow-x-auto max-w-xs">
                <div *ngFor="let ref of referenceImages[input.name]; let i = index" class="relative h-12 w-12 flex-shrink-0">
                  <!-- Use $any(ref) to avoid type errors since referenceImages is mixed now -->
                  <img *ngIf="input.type === 'image'" [src]="$any(ref).previewUrl" class="h-full w-full rounded-lg object-cover" />
                  <div *ngIf="input.type === 'video'" class="h-full w-full rounded-lg bg-neutral-800 flex items-center justify-center border border-neutral-700">
                    <mat-icon class="text-neutral-500 !text-lg !w-5 !h-5">
                      movie
                    </mat-icon>
                  </div>
                  <button
                    (click)="clearReferenceImage(input.name, i)"
                    class="absolute -right-1 -top-1 rounded-full bg-neutral-900 p-0.5 text-neutral-400 hover:text-white"
                  >
                    <mat-icon class="!h-3 !w-3 text-xs">close</mat-icon>
                  </button>
                </div>
              </div>
          </div>
          <!-- / Inputs image -->
          <mat-form-field *ngIf="inputModes[input.name] === 'linked'" appearance="outline" class="value-input">
            <mat-select [formControlName]="input.name" [compareWith]="compareFn">
              <mat-option *ngFor="let out of compatibleOutputs[input.name]" [value]="out.value">
                {{ out.label }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="showValidationErrors && stepForm.get('inputs')?.get(input.name)?.hasError('required')">
              Input is required
            </mat-error>
          </mat-form-field>
        </div>
        </div>
      </ng-container>
    </div>

    <div class="section settings" formGroupName="settings">
      <h3>Settings</h3>
      <div class="settings-grid">
        <ng-container *ngFor="let setting of localConfig.settings">
          <ng-container *ngIf="!setting.hidden">
          <mat-form-field *ngIf="setting.type === 'select'" appearance="outline">
            <mat-label>{{ setting.label }}</mat-label>
            <mat-select [formControlName]="setting.name">
              <mat-option *ngFor="let option of setting.options" [value]="option.value">{{ option.label }}</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field *ngIf="setting.type === 'text' || setting.type === 'textarea'" appearance="outline">
            <mat-label>{{ setting.label }}</mat-label>
            <input matInput [formControlName]="setting.name">
          </mat-form-field>
          <div *ngIf="setting.type === 'checkbox'" class="checkbox-group">
            <mat-checkbox [formControlName]="setting.name">{{ setting.label }}</mat-checkbox>
          </div>
          <div *ngIf="setting.type === 'slider'" class="slider-group">
            <label>{{ setting.label }}: {{ stepForm.get('settings')?.get(setting.name)?.value }}</label>
            <mat-slider [min]="setting.min || 0" [max]="setting.max || 1" [step]="setting.step || 0.1">
              <input matSliderThumb [formControlName]="setting.name">
            </mat-slider>
          </div>
          <div *ngIf="setting.type === 'radio'" class="radio-group">
            <label>{{ setting.label }}</label>
            <mat-radio-group [formControlName]="setting.name">
              <mat-radio-button *ngFor="let option of setting.options" [value]="option.value">
                {{ option.label }}
              </mat-radio-button>
            </mat-radio-group>
          </div>
          </ng-container>
        </ng-container>
      </div>
    </div>

    <div class="section outputs">
      <h3>Outputs</h3>
      <div *ngFor="let output of localConfig.outputs" class="output-pill">
        <mat-icon>{{ output.type }}</mat-icon> {{ output.label }}
      </div>
    </div>
  </div>
</div>
